{% extends "base.html" %}
{% import "macros.html" as macro %}

{% block main %}
{# 收集所有文章 #}
{% set all_section = get_section(path="blog/_index.md") %}
{% set_global all_pages = [] %}

{# 添加根section的页面 #}
{% for page_item in all_section.pages %}
  {% set_global all_pages = all_pages | concat(with=page_item) %}
{% endfor %}

{# 添加所有子section的页面 #}
{% for subsection_path in all_section.subsections %}
  {% set subsection = get_section(path=subsection_path) %}
  {% for page_item in subsection.pages %}
    {% set_global all_pages = all_pages | concat(with=page_item) %}
  {% endfor %}
{% endfor %}

<div class="main-box-block">
  <h1>特殊日期</h1>
  <p class="special-date-intro">在这里查看特定日期发生了什么。点击侧边栏日历中的日期即可查看对应日期的所有内容。</p>
  
  <div id="special-date-content">
    <!-- JavaScript将在这里动态渲染内容 -->
  </div>
</div>

<style>
.special-date-intro {
  color: var(--colors-text-muted);
  margin-bottom: 2rem;
  font-size: 0.95rem;
}

.special-date-header {
  margin-bottom: 2rem;
  padding-bottom: 1rem;
  border-bottom: 2px solid var(--colors-border);
}

.special-date-title {
  font-size: 1.8rem;
  margin-bottom: 0.5rem;
  color: var(--colors-text);
}

.special-date-subtitle {
  color: var(--colors-text-muted);
  font-size: 0.95rem;
}

.year-group {
  margin-bottom: 2.5rem;
}

.year-group h2 {
  font-size: 1.5rem;
  margin-bottom: 1rem;
  color: var(--colors-text);
  border-bottom: 1px solid var(--colors-border);
  padding-bottom: 0.5rem;
}

.year-group ul {
  list-style: none;
  padding: 0;
  margin: 0;
}

.year-group li {
  margin-bottom: 0.8rem;
  padding-left: 0;
}

.no-articles {
  color: var(--colors-text-muted);
  font-style: italic;
  padding: 2rem 0;
  text-align: center;
}
</style>

<script>
(function() {
  'use strict';

  // 所有文章数据
  const allArticles = [
    {% for page_item in all_pages %}
      {% if page_item.date or page_item.updated %}
      {
        title: {{ page_item.title | json_encode() | safe }},
        permalink: {{ page_item.permalink | json_encode() | safe }},
        description: {{ page_item.description | default(value="") | json_encode() | safe }},
        date: {% if page_item.date %}{{ page_item.date | json_encode() | safe }}{% else %}null{% endif %},
        updated: {% if page_item.updated %}{{ page_item.updated | json_encode() | safe }}{% else %}null{% endif %},
        year: {% if page_item.date %}{{ page_item.date | date(format="%Y") | json_encode() | safe }}{% elif page_item.updated %}{{ page_item.updated | date(format="%Y") | json_encode() | safe }}{% else %}""{% endif %}
      },
      {% endif %}
    {% endfor %}
  ];

  // 从URL hash中获取日期
  // 支持两种格式:
  // 1. YYYY-MM-DD (日历点击,只显示该年该日期)
  // 2. MM-DD (特殊日期/去年今日,显示所有年份该日期)
  function getDateFromHash() {
    const hash = window.location.hash.substring(1); // 移除 #

    // 格式1: YYYY-MM-DD
    if (/^\d{4}-\d{2}-\d{2}$/.test(hash)) {
      return {
        type: 'specific',
        year: hash.substring(0, 4),
        monthDay: hash.substring(5) // MM-DD
      };
    }

    // 格式2: MM-DD
    if (/^\d{2}-\d{2}$/.test(hash)) {
      return {
        type: 'all-years',
        monthDay: hash
      };
    }

    return null;
  }

  // 格式化日期为 MM-DD
  function formatDate(dateStr) {
    if (!dateStr) return null;
    const date = new Date(dateStr);
    const month = String(date.getMonth() + 1).padStart(2, '0');
    const day = String(date.getDate()).padStart(2, '0');
    return month + '-' + day;
  }

  // 渲染特定日期的文章
  function renderDateArticles(dateInfo) {
    const contentEl = document.getElementById('special-date-content');
    if (!contentEl) return;

    let matchedArticles;
    let titleText;

    if (dateInfo.type === 'specific') {
      // 日历点击: 只显示特定年份+日期的内容
      const targetYear = dateInfo.year;
      const targetMonthDay = dateInfo.monthDay;

      matchedArticles = allArticles.filter(function(article) {
        if (article.year !== targetYear) return false;

        const articleDate = formatDate(article.date);
        const articleUpdated = formatDate(article.updated);
        return articleDate === targetMonthDay || articleUpdated === targetMonthDay;
      });

      titleText = targetYear + '年' + targetMonthDay.replace('-', '月') + '日';

    } else {
      // 特殊日期/去年今日: 显示所有年份该日期的内容
      const targetMonthDay = dateInfo.monthDay;

      matchedArticles = allArticles.filter(function(article) {
        const articleDate = formatDate(article.date);
        const articleUpdated = formatDate(article.updated);
        return articleDate === targetMonthDay || articleUpdated === targetMonthDay;
      });

      titleText = targetMonthDay.replace('-', '月') + '日 (所有年份)';
    }

    if (matchedArticles.length === 0) {
      contentEl.innerHTML = '<div class="no-articles">该日期暂无内容</div>';
      return;
    }

    // 按年份分组
    const articlesByYear = {};
    matchedArticles.forEach(function(article) {
      const year = article.year;
      if (!articlesByYear[year]) {
        articlesByYear[year] = [];
      }
      articlesByYear[year].push(article);
    });

    // 获取年份并降序排列
    const years = Object.keys(articlesByYear).sort(function(a, b) {
      return parseInt(b) - parseInt(a);
    });

    // 构建HTML
    let html = '<div class="special-date-header">';
    html += '<h2 class="special-date-title">' + titleText + '</h2>';
    html += '<p class="special-date-subtitle">共找到 ' + matchedArticles.length + ' 篇内容</p>';
    html += '</div>';

    // 如果是特定年份,不需要显示年份分组
    if (dateInfo.type === 'specific' && years.length === 1) {
      html += '<ul>';
      matchedArticles.forEach(function(article) {
        html += '<li>';
        html += '<a href="' + article.permalink + '">' + article.title + '</a>';
        if (article.description) {
          html += '<p style="color: var(--colors-text-muted); font-size: 0.9rem; margin: 0.3rem 0 0 0;">' + article.description + '</p>';
        }
        html += '</li>';
      });
      html += '</ul>';
    } else {
      // 显示年份分组
      years.forEach(function(year) {
        html += '<div class="year-group">';
        html += '<h2>' + year + '</h2>';
        html += '<ul>';

        articlesByYear[year].forEach(function(article) {
          html += '<li>';
          html += '<a href="' + article.permalink + '">' + article.title + '</a>';
          if (article.description) {
            html += '<p style="color: var(--colors-text-muted); font-size: 0.9rem; margin: 0.3rem 0 0 0;">' + article.description + '</p>';
          }
          html += '</li>';
        });

        html += '</ul>';
        html += '</div>';
      });
    }

    contentEl.innerHTML = html;
  }

  // 初始化
  function init() {
    console.log('Special dates page init called');
    const dateInfo = getDateFromHash();
    console.log('Date info from hash:', dateInfo);
    console.log('All articles count:', allArticles.length);

    if (dateInfo) {
      renderDateArticles(dateInfo);
    } else {
      const contentEl = document.getElementById('special-date-content');
      if (contentEl) {
        contentEl.innerHTML = '<div class="no-articles">请从侧边栏日历中选择一个日期</div>';
      }
    }
  }

  // 监听hash变化
  window.addEventListener('hashchange', function() {
    console.log('Hash changed');
    init();
  });

  // 页面加载时初始化 - 使用多种方式确保执行
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', function() {
      // 延迟一点确保hash已经设置
      setTimeout(init, 50);
    });
  } else {
    // DOM已经加载完成，立即执行
    setTimeout(init, 50);
  }

  // 额外的保险措施
  window.addEventListener('load', function() {
    setTimeout(init, 50);
  });
})();
</script>

{% endblock main %}
