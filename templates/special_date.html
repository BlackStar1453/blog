{% extends "base.html" %}
{% import "macros.html" as macro %}

{% block extra_head %}
  <link rel="stylesheet" href="{{ get_url(path='site/styles/birthday.css') }}">
  {% if special_config %}
    <link rel="stylesheet" href="{{ get_url(path='site/styles/birthday-intro.css') }}">
  {% endif %}
{% endblock extra_head %}

{% block main %}
  <div class="special-date-page">
    {# æŸ¥æ‰¾å½“å‰æ—¥æœŸçš„ç‰¹æ®Šæ—¥æœŸé…ç½® #}
    {% set_global special_config = false %}
    {% if config.extra.special_dates and config.extra.special_dates.dates %}
      {% for date_config in config.extra.special_dates.dates %}
        {% set month_str = date_config.month %}
        {% if date_config.month < 10 %}
          {% set month_str = "0" ~ date_config.month %}
        {% endif %}
        {% set day_str = date_config.day %}
        {% if date_config.day < 10 %}
          {% set day_str = "0" ~ date_config.day %}
        {% endif %}
        {% set config_date = month_str ~ "-" ~ day_str %}
        {% if config_date == page.extra.target_date %}
          {% set_global special_config = date_config %}
        {% endif %}
      {% endfor %}
    {% endif %}

    {# å¦‚æœæœ‰ç‰¹æ®Šæ—¥æœŸé…ç½®,æ˜¾ç¤ºç¥ç¦æ¨ªå¹… #}
    {% if special_config %}
      <div class="birthday-banner">
        <h1 class="birthday-title">ğŸ‚ ä»Šå¤©æ˜¯ {{ config.title }} çš„{{ special_config.title }}ï¼ğŸ‰</h1>
        <p class="birthday-message">{{ special_config.message }}</p>
      </div>
    {% endif %}

    <div class="main-box-block">
      <h1>{{ page.title }}</h1>
      <p class="special-date-description">{{ page.description }}</p>
      
      {% if page.extra.target_date %}
        {# æ”¶é›†æ‰€æœ‰é¡µé¢ #}
        {% set all_section_pages = get_section(path="_index.md") -%}
        {% set_global all_pages = [] -%}
        
        {# æ·»åŠ æ ¹sectionçš„é¡µé¢ #}
        {% for page_item in all_section_pages.pages -%}
          {% set_global all_pages = all_pages | concat(with=page_item) -%}
        {% endfor -%}
        
        {# æ·»åŠ æ‰€æœ‰å­sectionçš„é¡µé¢ #}
        {% for subsection in all_section_pages.subsections -%}
          {% set subsection_data = get_section(path=subsection) -%}
          {% for page_item in subsection_data.pages -%}
            {% set_global all_pages = all_pages | concat(with=page_item) -%}
          {% endfor -%}
        {% endfor -%}
        
        {# è¿‡æ»¤å‡ºåŒ¹é…ç›®æ ‡æ—¥æœŸçš„é¡µé¢ #}
        {% set_global matched_pages = [] -%}
        {% for page_item in all_pages -%}
          {% if page_item.date %}
            {% set page_date = page_item.date | date(format="%m-%d") %}
            {% if page_date == page.extra.target_date %}
              {% set_global matched_pages = matched_pages | concat(with=page_item) -%}
            {% endif %}
          {% endif %}
          {% if page_item.updated %}
            {% set page_updated = page_item.updated | date(format="%m-%d") %}
            {% if page_updated == page.extra.target_date %}
              {# æ£€æŸ¥æ˜¯å¦å·²ç»æ·»åŠ è¿‡è¿™ä¸ªé¡µé¢ #}
              {% set already_added = false %}
              {% for existing in matched_pages %}
                {% if existing.permalink == page_item.permalink %}
                  {% set_global already_added = true %}
                {% endif %}
              {% endfor %}
              {% if not already_added %}
                {% set_global matched_pages = matched_pages | concat(with=page_item) -%}
              {% endif %}
            {% endif %}
          {% endif %}
        {% endfor -%}
        
        {% if matched_pages | length > 0 %}
          {# æŒ‰å¹´ä»½åˆ†ç»„æ˜¾ç¤º #}
          {% for year, posts in matched_pages | group_by(attribute="year") %}
            <h2>{{ year }}å¹´</h2>
            <ul>
              {% for post in posts %}
                <li>{{ macro::post_min(page=post) }}</li>
              {% endfor %}
            </ul>
          {% endfor %}
        {% else %}
          <p>è¯¥æ—¥æœŸæš‚æ— å†…å®¹</p>
        {% endif %}
      {% else %}
        <p>é…ç½®é”™è¯¯: ç¼ºå°‘ target_date å‚æ•°</p>
      {% endif %}
    </div>
    {{ macro::webmentions(backlinks=page.backlinks) }}
  </div>

  {# å¦‚æœæœ‰ç‰¹æ®Šæ—¥æœŸé…ç½®,åŠ è½½ç”Ÿæ—¥åŠ¨ç”» #}
  {% if special_config %}
    <script src="{{ get_url(path='site/js/birthday-intro.js') }}"></script>
    <script>
      // åˆå§‹åŒ–å¼€åœºåŠ¨ç”»
      initBirthdayIntro('{{ config.title }}', '{{ special_config.title }}', '{{ special_config.message }}');
    </script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
    <script src="{{ get_url(path='site/js/birthday.js') }}"></script>
  {% endif %}
{% endblock main %}

