{% extends "base.html" -%}
{% block before_meta %}
  {% if config.extra.meilisearch_url %}
    {%- if config.mode=="build" -%}
    {%- set_global meilicss = load_data(path="static/site/styles/docs-searchbar.min.css") -%}
    {%- else -%}
      <link rel="preload" href="{{ get_url(path="site/styles/docs-searchbar.min.css", trailing_slash=false,cachebust=true) | safe }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
      <noscript>
        <link rel="stylesheet" href="{{ get_url(path="site/styles/docs-searchbar.min.css", trailing_slash=false,cachebust=true) | safe }}">
      </noscript>
    {%- endif -%}
  {% endif %}
{% endblock before_meta %}
{% block post_meta %}
  {%- if config.extra.meilisearch_url and config.mode=="build" -%}
    <style>{{meilicss | safe}}</style>
  {%- endif -%}
  {# 特殊日期功能样式 #}
  <link rel="stylesheet" href="{{ get_url(path='site/styles/special-date.css', trailing_slash=false, cachebust=true) | safe }}">
{% endblock post_meta %}

{% block sidebar_top %}{% endblock sidebar_top %}
{% block header %}
  {# 特殊日期横幅 - 极简文本风格 #}
  {% if config.extra.special_dates and config.extra.special_dates.dates %}
    {% set current_time = now() %}
    {% set current_month = current_time | date(format="%m") | int %}
    {% set current_day = current_time | date(format="%d") | int %}

    {% set_global active_special_date = false %}
    {% for special_date in config.extra.special_dates.dates %}
      {% if special_date.month == current_month and special_date.day == current_day %}
        {% set_global active_special_date = special_date %}
        {% break %}
      {% endif %}
    {% endfor %}

    {# 极简文本横幅 #}
    <a id="special-date-banner"
       class="special-date-banner"
       href="/special-dates/{{ current_month }}-{{ current_day }}/"
       data-special-dates='{{ config.extra.special_dates.dates | json_encode() | safe }}'
       style="{% if not active_special_date %}display: none;{% endif %}">
      <p class="special-date-banner-text">
        {% if active_special_date %}
          {{ active_special_date.message | default(value='今天是特殊的一天！🎉') }}
        {% else %}
          今天是特殊的一天！🎉
        {% endif %}
      </p>
      <p class="special-date-banner-hint">今天发生了什么？</p>
    </a>
  {% endif %}

  {% set all_section_pages = get_section(path="_index"~file_lang_path~".md") -%}
  {% set all_pages = all_section_pages.pages -%}

  {# 收集有更新时间的页面并排序 #}
  {% set_global pages_with_updated = [] -%}
  {% for page_item in all_pages -%}
    {% if page_item.updated and page_item.updated != "" -%}
      {% set_global pages_with_updated = pages_with_updated | concat(with=page_item) -%}
    {% endif -%}
  {% endfor -%}
  {% if pages_with_updated | length > 0 -%}
    {% set all_pages_sort_by_date = pages_with_updated | sort(attribute="updated") | reverse -%}
  {% else -%}
    {% set all_pages_sort_by_date = [] -%}
  {% endif -%}

  {# 计算总字数 #}
  {% set total_word_count = 0 -%}
  {% for page_item in all_pages -%}
    {% set_global total_word_count = total_word_count+page_item.word_count -%}
  {% endfor -%}
      <div class="header">
        <div class="header-inner">
        {% if config.default_language != lang %}
          <p class="index-intro">I'm {{ config.extra.author }}, I've written
            <a href="{{ get_url(path="@/pages/archive.md",lang=lang) }}">
              {{ all_pages | length }}</a>
            articles so far, about {{ total_word_count }} words{% if all_pages_sort_by_date | length > 0 %}, last updated on
            <time datetime="{{ all_pages_sort_by_date[0].updated }}">{{ all_pages_sort_by_date[0].updated }}</time>{% endif %}. I position
              this as my personal digital garden, where all my notes, ideas are stored here. Cause I'm not a English native speaker,
              so there are also
            <a href="/">many posts/notes written by Chinese</a>,
            <a href="{{ get_url(path="@/pages/now.md",lang=lang) }}">click to find out what I'm doing now</a>
          </p>
        {% else %}
          <p class="index-intro">我是<a href="{{ get_url(path="@/pages/about.md",lang=lang) }}">{{ config.extra.author }}</a>，截止目前已写了<a href="{{ get_url(path="@/pages/archive.md",lang=lang) }}">
              {{ all_pages | length }}</a>
          篇文章，大约 {{ total_word_count }} 字{% if all_pages_sort_by_date | length > 0 %}，最后更新时间：<time datetime="{{ all_pages_sort_by_date[0].updated }}">{{ all_pages_sort_by_date[0].updated }}</time>{% endif %}。 我在<a href="/thoughts">短想法</a>里记录自己随手记的一些东西，
          在 <a href="{{ get_url(path="@/pages/about.md",lang=lang) }}">About</a> 页面了解更多关于我的介绍，在 <a href="{{ get_url(path="@/pages/now.md",lang=lang) }}">Now 页面</a>了解我最近在做什么。
          </p>

        {% endif %}
        <input aria-label="search input" type="search" id="search-bar-input" placeholder="Search" class="relative"/>
        </div>
      </div>
{% endblock%}
{% block main -%}
  {% set_global note_pages = [] -%}
  {% set_global all_blog_pages = [] -%}
  {% set all_categories = get_taxonomy(kind="categories",lang=lang) -%}
  {% for cat in all_categories.items -%}
    {% set_global all_blog_pages = all_blog_pages | concat(with=cat.pages) -%}
    {% if cat.name == "Notes" -%}
      {% set_global note_pages = [] -%}
      {% for p in cat.pages -%}
        {% if p.updated -%}
          {% set_global note_pages = note_pages | concat(with=p) -%}
        {% endif -%}
      {% endfor -%}
      {% set_global note_pages = note_pages | sort(attribute="updated") | reverse -%}
    {% endif -%}
  {% endfor -%}
  {% set_global all_blog_pages_sorted = [] -%}
  {% for p in all_blog_pages -%}
    {% if p.updated -%}
      {% set_global all_blog_pages_sorted = all_blog_pages_sorted | concat(with=p) -%}
    {% endif -%}
  {% endfor -%}
  {% set_global all_blog_pages_sorted = all_blog_pages_sorted | sort(attribute="updated") | reverse -%}
  <div class="index-page py">

      {% set index_first = get_page(path="pages/index_first"~file_lang_path~".md") %}
      {{ index_first.content | safe }}

      <details open class="py">
      <summary class="by">{{ trans(key="label_thoughts_title",lang=lang) | markdown(inline=true) | safe }}<a href="#thoughts" id="thoughts" class="zola-anchor">🔗</a>
      </summary>
      {% set thoughts_page = get_page(path="thoughts/index" ~ file_lang_path ~ ".md",lang=lang) %}
      <div class="articles">
        {{ thoughts_page.summary | safe }}
        <p class="no-border">{{ trans(key="label_all_thoughts",lang=lang) | markdown(inline=true) | safe }}</p>
      </div>
      </details>
      {# 尝试加载 music_playlist.json，如果不存在则隐藏播放器 #}
      {% set_global has_music_playlist = false -%}
      {% set music_data = load_data(path="static/media/music_playlist.json", required=false) -%}
      {% if music_data -%}
        {% if music_data is iterable and music_data | length > 0 -%}
          {% set_global has_music_playlist = true -%}
        {% endif -%}
      {% endif -%}

      {% if has_music_playlist %}
        <details open class="py">
          <summary class="by">最近在听<a href="#now-playing" id="now-playing" class="zola-anchor">🔗</a></summary>
          <div class="articles">
            <p class="no-border">记录最近在听的歌。</p>
            {{ macro::music_playlist_block(
              source="/media/",
              manifest="music_playlist.json",
              title="Recent Listening",
              list_folded=false,
              preload="metadata",
              default_cover="/media/playlist-cover.svg"
            ) }}
          </div>
        </details>
      {% endif %}
      <details open class="py">
        <summary class="by ">{{ trans(key="label_new_posts_list_title",lang=lang) | markdown(inline=true) | safe }}:
      </summary>
      <div class="articles h-feed hfeed">
        {% for page in all_blog_pages_sorted | slice(start=0,end=3) %}
          {{ macro::post_max(page=page,index=loop.index) }}
        {% endfor %}
      </div>
      </details>
      {%if all_blog_pages_sorted | slice(start=3) | length > 0%}
        <details class="py">
          <summary class="by text">{{ trans(key="label_all_posts",lang=lang) | markdown(inline=true) | safe }}</summary>
          <ul>
            {% for page in all_blog_pages_sorted | slice(start=3) %}
            <li>{{ macro::post_min(page=page) }}</li>
            {% endfor %}
          </ul>
        </details>
        {% endif %}
                  <iframe src="https://embeds.beehiiv.com/482231fd-f9a5-4134-8237-6f00fdadf0e1?slim=true" data-test-id="beehiiv-embed" height="52" frameborder="0" scrolling="no" style="margin: 0; border-radius: 0px !important; background-color: transparent;"></iframe>


      <details open class="py">
      <summary class="by">{{ trans(key="label_quotes_title",lang=lang) | markdown(inline=true) | safe }}<a href="#quotes" id="quotes" class="zola-anchor">🔗</a>
      </summary>
      {% set quotes_page = get_page(path="quotes" ~ file_lang_path ~ ".md",lang=lang) %}
      <div class="articles">
        {{ quotes_page.summary | safe }}
        <p class="no-border">{{ trans(key="label_all_quotes",lang=lang) | markdown(inline=true) | safe }}</p>
      </div>
      </details>
      {% set all_categories = get_taxonomy(kind="categories",lang=lang) -%}
            {% set_global note_pages = [] -%}
            {% for cat in all_categories.items -%}
              {% if cat.name == "Notes" -%}
                {% set_global note_pages = [] -%}
                {% for p in cat.pages -%}
                  {% if p.updated -%}
                    {% set_global note_pages = note_pages | concat(with=p) -%}
                  {% endif -%}
                {% endfor -%}
                {% set_global note_pages = note_pages | sort(attribute="updated") | reverse -%}
              {% endif -%}
      {% endfor -%}

            <div class="by">{{ trans(key="label_latest_notes_title",lang=lang) | markdown(inline=true) | safe }}</div>
            <div class="articles pb-lg">
              <ul class="root-ul">
                {% for page in note_pages | slice(end=10) %}
                  <li>{{ macro::post_min(page=page) }}</li>
                {% endfor %}
              </ul>
              {%if note_pages | slice(start=10) | length > 0%}
              <details>
                <summary>{{ trans(key="label_toggle_more",lang=lang) }}</summary>
                <ul>
                  {% for page in note_pages | slice(start=10) %}
                  <li>{{ macro::post_min(page=page) }}</li>
                  {% endfor %}
                </ul>
              </details>
              {% endif %}
            </div>

    </div>

  {% endblock main -%}
  {% block before_body_end %}
    {{ super() }}
    {# 特殊日期功能 JavaScript #}
    {% if config.extra.special_dates and config.extra.special_dates.dates %}
      <script defer src="{{ get_url(path='site/js/special-date.js', trailing_slash=false, cachebust=true) | safe }}"></script>
    {% endif %}
    {% if config.extra.meilisearch_url %}
      <script defer src="{{ get_url(path="site/js/docs-searchbar.min.js", trailing_slash=false,cachebust=true) | safe }}"></script>
      <script>
        document.addEventListener('DOMContentLoaded', function () {
          // Check if search input exists before initializing
          const searchInput = document.querySelector('#search-bar-input');
          if (searchInput && typeof docsSearchBar === 'function') {
            try {
              docsSearchBar({
                hostUrl: '{{ config.extra.meilisearch_url | safe }}',
                apiKey: '{{ config.extra.meilisearch_api_key | safe }}',
                indexUid: 'owen-blog',
                inputSelector: '#search-bar-input',
                meilisearchOptions: {
                  limit: 10
                },
                debug: false, // Set debug to true if you want to inspect the dropdown
              });
            } catch (error) {
              console.warn('Search initialization failed:', error);
            }
          }
        });
      </script>
    {% endif %}
  {% endblock before_body_end %}
